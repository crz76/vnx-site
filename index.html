<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VNX — dApp officielle</title>
  <meta name="description" content="VNX (ERC-20) — 0,20% cap 1 VNX → 70% Stakers / 20% Treasury / 10% Burn. Swap • Stake • Send en 1 page." />
  <meta property="og:title" content="VNX — dApp officielle" />
  <meta property="og:description" content="VNX (ERC-20) — 0,20% cap 1 VNX → 70% Stakers / 20% Treasury / 10% Burn. Swap • Stake • Send en 1 page." />
  <meta property="og:image" content="https://crz76.github.io/vnx-assets/vnx_logo_200.png" />
  <meta name="theme-color" content="#6F3AFF" />
  <link rel="icon" href="https://raw.githubusercontent.com/crz76/vnx-assets/refs/heads/main/vnx_logo_64.svg" type="image/svg+xml" />
  <link rel="preload" as="image" href="https://raw.githubusercontent.com/crz76/vnx-assets/refs/heads/main/vnx_logo_64.svg" fetchpriority="high">
  <style>
    :root{
      --bg: #0b1020;
      --card: rgba(255,255,255,0.06);
      --border: rgba(255,255,255,0.12);
      --text: #eef2ff;
      --muted: #b8c1ff;
      --accent1: #6F3AFF;
      --accent2: #408CFF;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(64,140,255,0.25), transparent 60%),
        radial-gradient(900px 500px at 100% 0%, rgba(111,58,255,0.28), transparent 60%), var(--bg);
      font: 16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }
    a{color:#cfe0ff}
    .container{max-width:1080px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;gap:18px;margin:18px 0 28px}
    header img.logo{width:64px;height:64px;border-radius:14px;box-shadow:var(--shadow)}
    h1{font-size:28px;margin:0}
    .muted{color:var(--muted)}
    .bar{display:flex;flex-wrap:wrap;gap:12px;margin:8px 0 24px}
    .btn{
      appearance:none;border:1px solid var(--border);background:var(--card);color:var(--text);
      padding:10px 14px;border-radius:12px;cursor:pointer;transition:.2s;backdrop-filter: blur(6px);
      box-shadow:var(--shadow); text-decoration:none; display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{border-color:#9aa3ff;background:rgba(255,255,255,0.1)}
    .grid{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:16px}
    @media (max-width:780px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card); border:1px solid var(--border); padding:18px; border-radius:var(--radius); backdrop-filter: blur(6px); box-shadow: var(--shadow)}
    .card h3{margin:0 0 8px;font-size:18px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    code.addr{user-select:all; font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; font-size:14px; color:#d7ddff}
    .pill{font-size:12px;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,0.06)}
    footer{margin:28px 0 16px;color:#9fb0ff80;font-size:13px}
    .hero{
      position:relative; border-radius:20px; overflow:hidden; padding:18px; border:1px solid var(--border);
      background: linear-gradient(135deg, rgba(111,58,255,0.22), rgba(64,140,255,0.18));
      box-shadow:var(--shadow);
    }
    .hero h2{margin:0 0 8px; font-size:22px}
    .hero p{margin:0}
    .accent{background: linear-gradient(90deg, var(--accent2), var(--accent1)); -webkit-background-clip:text; background-clip:text; color:transparent; font-weight:700}
    .small{font-size:13px}
    /* ensure wallet buttons stay above embeds */
    header, .bar, #btnConnect { position: relative; z-index: 50; }
    .uniswap-embed, .uniswap-widget, #uniFrame, #uniFallback { position: relative; z-index: 1; }
    /* inputs */
    input, select{background:rgba(255,255,255,0.06); border:1px solid var(--border); color:var(--text);
      border-radius:10px; padding:8px 10px; min-width:0;}
    label{font-size:13px;color:#c9d3ff}
    .col{display:flex;flex-direction:column;gap:8px}
    .row-between{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .hl{color:#a3b8ff}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img class="logo" src="https://raw.githubusercontent.com/crz76/vnx-assets/refs/heads/main/vnx_logo_64.svg" alt="VNX logo" decoding="async" loading="eager" width="64" height="64" />
      <div style="flex:1">
        <h1>VNX — <span data-i18n="title">dApp officielle</span></h1>
        <div class="muted small">ERC-20 • 0,20% cap 1 VNX → 70% Stakers / 20% Treasury / 10% Burn</div>
        <div class="bar">
          <a class="btn" href="#trade" data-i18n="buyTrade">Acheter / Échanger</a>
          <button class="btn" id="btnConnect">Connect Wallet</button>
          <span class="pill" id="walletStatus" style="display:none"></span>
          <button class="btn" id="btnAddMM" data-i18n="addMM">Ajouter VNX à MetaMask</button>
          <button class="btn" id="btnLang">EN</button>
          <a class="btn" target="_blank" href="https://etherscan.io/token/0x27BB16f90E4B007c51430d1c76152Ad6B5E8fD41">Etherscan</a>
        </div>
      </div>
    </header>

    <section class="hero">
      <h2 data-i18n="addresses">Adresses</h2>
      <div class="grid">
        <div class="card">
          <h3>Token (VNX) <span class="pill">ERC-20</span></h3>
          <div class="row">
            <code class="addr" id="addrToken">0x27BB16f90E4B007c51430d1c76152Ad6B5E8fD41</code>
            <button class="btn small" data-copy="#addrToken" data-i18n="copy">Copier</button>
            <a class="btn small" target="_blank" href="https://etherscan.io/token/0x27BB16f90E4B007c51430d1c76152Ad6B5E8fD41">Etherscan</a>
          </div>
        </div>
        <div class="card">
          <h3>Staking</h3>
          <div class="row">
            <code class="addr" id="addrStake">0x75b3812a532A3E9d3487AFAae28FF6e5383EC2f8</code>
            <button class="btn small" data-copy="#addrStake" data-i18n="copy">Copier</button>
            <a class="btn small" target="_blank" href="https://etherscan.io/address/0x75b3812a532A3E9d3487AFAae28FF6e5383EC2f8">Etherscan</a>
          </div>
        </div>
        <div class="card">
          <h3>Uniswap V2 Pair (VNX / ETH)</h3>
          <div class="row">
            <code class="addr" id="addrPair">0x5De3F5d74e692e7Ed2d999A17b127910ff462845</code>
            <button class="btn small" data-copy="#addrPair" data-i18n="copy">Copier</button>
            <a class="btn small" target="_blank" href="https://etherscan.io/address/0x5De3F5d74e692e7Ed2d999A17b127910ff462845">Etherscan</a>
          </div>
        </div>
        <div class="card">
          <h3 data-i18n="marketsTitle">Marchés</h3>
          <div class="row">
            <a class="btn small" target="_blank" href="https://dexscreener.com/ethereum/0x5de3f5d74e692e7ed2d999a17b127910ff462845">Dexscreener</a>
            <a class="btn small" target="_blank" href="https://app.uniswap.org/#/swap?chain=mainnet&inputCurrency=ETH&outputCurrency=0x27BB16f90E4B007c51430d1c76152Ad6B5E8fD41">Uniswap</a>
          </div>
        </div>
      </div>
    </section>

    <section id="trade" style="margin-top:22px">
      <div class="card">
        <h3 data-i18n="buyTrade">Acheter / Échanger</h3>
        <p class="muted" data-i18n="useUniswap">Utilisez Uniswap ou le swap natif (backup).</p>

        <!-- Uniswap official embed -->
        <div class="col uniswap-embed">
          <iframe id="uniFrame" class="uniswap-widget" title="Uniswap"
            src="https://app.uniswap.org/#/swap?chain=mainnet&theme=dark&embed=true&use=V2&inputCurrency=ETH&outputCurrency=0x27BB16f90E4B007c51430d1c76152Ad6B5E8fD41"
            style="width:100%;height:650px;border:0;border-radius:16px;box-shadow:var(--shadow)"
            loading="lazy" allow="clipboard-write *; web-share *; fullscreen *; accelerometer *; gyroscope *; payment *"
            sandbox="allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-forms">
          </iframe>

          <div id="uniFallback" style="display:none;margin-top:10px;">
            <p class="muted" data-i18n="widgetBlocked">Si le widget ne s'affiche pas (protection navigateur), utilisez le bouton “Ouvrir Uniswap” ci-dessous.</p>
          </div>
          <div class="bar">
            <a class="btn" target="_blank" id="btnOpenUni" href="https://app.uniswap.org/#/swap?chain=mainnet&use=V2&inputCurrency=ETH&outputCurrency=0x27BB16f90E4B007c51430d1c76152Ad6B5E8fD41" data-i18n="openUni">Ouvrir Uniswap</a>
            <button class="btn" id="btnAddList" data-i18n="addList">Ajouter la Tokenlist à Uniswap</button>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid var(--border);margin:18px 0">

        <!-- Native swap backup -->
        <div class="grid">
          <div class="card">
            <h3>ETH → VNX (V2)</h3>
            <div class="col">
              <label>Montant ETH</label>
              <input id="ethIn" type="number" min="0" step="0.0001" placeholder="0.1">
              <div class="row-between">
                <div>
                  <label>Slippage</label>
                  <input id="slipBuy" type="number" min="0" step="0.1" value="1"> %
                </div>
                <div>
                  <label>Deadline</label>
                  <input id="deadlineBuy" type="number" min="1" step="1" value="15"> min
                </div>
              </div>
              <div class="small muted" id="quoteBuy">—</div>
              <div class="bar">
                <button class="btn" id="btnQuoteBuy">Quote</button>
                <button class="btn" id="btnSwapBuy">Swap</button>
              </div>
            </div>
          </div>
          <div class="card">
            <h3>VNX → ETH (V2)</h3>
            <div class="col">
              <label>Montant VNX</label>
              <input id="vnxIn" type="number" min="0" step="0.01" placeholder="100">
              <div class="row-between">
                <div>
                  <label>Slippage</label>
                  <input id="slipSell" type="number" min="0" step="0.1" value="1"> %
                </div>
                <div>
                  <label>Deadline</label>
                  <input id="deadlineSell" type="number" min="1" step="1" value="15"> min
                </div>
              </div>
              <div class="small muted" id="quoteSell">—</div>
              <div class="bar">
                <button class="btn" id="btnApproveRouter">Approve Router</button>
                <button class="btn" id="btnQuoteSell">Quote</button>
                <button class="btn" id="btnSwapSell">Swap</button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <section style="margin-top:22px">
      <div class="grid">
        <!-- Staking -->
        <div class="card">
          <h3>Staking</h3>
          <div class="small muted" id="stakeInfo">—</div>
          <div class="col" style="margin-top:8px">
            <label>Montant VNX</label>
            <input id="stakeAmt" type="number" min="0" step="0.01" placeholder="100">
            <div class="bar">
              <button class="btn" id="btnApproveStake">Approve Staking</button>
              <button class="btn" id="btnStake">Stake</button>
              <button class="btn" id="btnClaim">Claim</button>
              <button class="btn" id="btnWithdraw">Withdraw</button>
            </div>
          </div>
        </div>

        <!-- Approvals viewer / revoke -->
        <div class="card">
          <h3>Approvals — Viewer / Revoke</h3>
          <div class="col">
            <div class="small">Spenders rapides :</div>
            <div class="bar">
              <button class="btn small" data-spender="0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D">Uniswap V2 Router</button>
              <button class="btn small" data-spender="0x75b3812a532A3E9d3487AFAae28FF6e5383EC2f8">Staking</button>
            </div>
            <label>Spender</label>
            <input id="inpSpender" type="text" placeholder="0x...">
            <div class="bar">
              <button class="btn" id="btnCheckAllowance">Check Allowance</button>
              <button class="btn" id="btnRevoke">Revoke (0)</button>
              <button class="btn" id="btnMax">Max (type(uint256).max)</button>
            </div>
            <div class="small muted" id="allowanceOut">—</div>
          </div>
        </div>
      </div>
    </section>

    <section style="margin-top:22px">
      <div class="grid">
        <div class="card">
          <h3>Guides</h3>
          <ul class="small">
            <li><b>Ajouter la Tokenlist</b> : bouton “Ajouter la Tokenlist à Uniswap” (copie l’URL et ouvre Uniswap).</li>
            <li><b>Ajouter VNX dans MetaMask</b> : bouton “Ajouter VNX à MetaMask”.</li>
            <li><b>Ajout manuel</b> : MetaMask → Import tokens → Adresse = <span class="hl">0x27BB16f90E4B007c51430d1c76152Ad6B5E8fD41</span> • Symbol = <span class="hl">VNX</span> • Decimals = <span class="hl">18</span>.</li>
          </ul>
          <div class="bar">
            <button class="btn" id="btnCopyList">Copier l’URL de la Tokenlist</button>
          </div>
          <div class="small muted">Tokenlist : <code>https://raw.githubusercontent.com/crz76/vnx-assets/main/vnx-tokenlist.json</code></div>
        </div>

        <div class="card">
          <h3>Contact</h3>
          <p class="small">Email: <a href="mailto:vnxtokenproject@gmail.com">vnxtokenproject@gmail.com</a></p>
          <p class="small">Telegram: <a target="_blank" href="https://t.me/vnxtoken">t.me/vnxtoken</a> • X/Twitter: <a target="_blank" href="https://x.com/VnxToken">@VnxToken</a></p>
          <p class="small muted">Site informatif, pas un conseil en investissement.</p>
        </div>
      </div>
    </section>

    <footer>
      <p>© 2025 VNX • <span class="accent">Ethereum Mainnet</span></p>
      <p class="small"><a class="link" target="_blank" href="https://t.me/vnxtoken">Telegram</a> · <a class="link" target="_blank" href="https://x.com/VnxToken">X/Twitter</a></p>
    </footer>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.15.0/dist/ethers.umd.min.js"></script>

  <script>
  /*************** CONFIG ***************/
  const ADDR = {
    TOKEN:   "0x27BB16f90E4B007c51430d1c76152Ad6B5E8fD41",
    STAKING: "0x75b3812a532A3E9d3487AFAae28FF6e5383EC2f8",
    ROUTER:  "0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D",
    PAIR:    "0x5De3F5d74e692e7Ed2d999A17b127910ff462845",
    WETH:    "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2"
  };
  const TOKENLIST_URL = "https://raw.githubusercontent.com/crz76/vnx-assets/main/vnx-tokenlist.json";

  /*************** I18N (FR/EN) ***************/
  const I18N = {
    fr: {
      title:"dApp officielle",
      buyTrade:"Acheter / Échanger",
      useUniswap:"Utilisez Uniswap ou le swap natif (backup).",
      addresses:"Adresses",
      copy:"Copier",
      marketsTitle:"Marchés",
      widgetBlocked:"Si le widget ne s'affiche pas (protection navigateur), utilisez le bouton “Ouvrir Uniswap” ci-dessous.",
      openUni:"Ouvrir Uniswap",
      addList:"Ajouter la Tokenlist à Uniswap",
      addMM:"Ajouter VNX à MetaMask",
    },
    en: {
      title:"Official dApp",
      buyTrade:"Buy / Trade",
      useUniswap:"Use Uniswap or the native backup swap.",
      addresses:"Addresses",
      copy:"Copy",
      marketsTitle:"Markets",
      widgetBlocked:"If the widget is blocked by your browser, use the “Open Uniswap” button below.",
      openUni:"Open Uniswap",
      addList:"Add Tokenlist to Uniswap",
      addMM:"Add VNX to MetaMask",
    }
  }
  function applyI18n(lang){
    document.querySelectorAll("[data-i18n]").forEach(el=>{
      const k = el.getAttribute("data-i18n");
      el.textContent = I18N[lang][k] || el.textContent;
    });
    document.getElementById("btnLang").textContent = (lang==="fr"?"EN":"FR");
    document.documentElement.lang = lang;
    localStorage.setItem("vnx_lang", lang);
  }
  (function initLang(){
    const saved = localStorage.getItem("vnx_lang") || "fr";
    applyI18n(saved);
    document.getElementById("btnLang").addEventListener("click",()=>{
      applyI18n(document.documentElement.lang==="fr"?"en":"fr");
    });
  })();

  /*************** Copy buttons & misc ***************/
  document.querySelectorAll("[data-copy]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const el = document.querySelector(btn.getAttribute("data-copy"));
      if(!el) return;
      navigator.clipboard.writeText(el.textContent.trim()).then(()=>{
        const old = btn.textContent; btn.textContent = (document.documentElement.lang==="fr"?"Copié":"Copied");
        setTimeout(()=>btn.textContent=old,1200);
      });
    });
  });

  const listUrl = TOKENLIST_URL;
  document.getElementById("btnCopyList")?.addEventListener("click", ()=>{
    navigator.clipboard.writeText(listUrl).then(()=>{
      alert("Tokenlist URL copiée : " + listUrl);
    });
  });
  document.getElementById("btnAddList")?.addEventListener("click", ()=>{
    navigator.clipboard.writeText(listUrl).then(()=>{
      window.open("https://app.uniswap.org/#/tokens/ethereum","_blank");
      alert("URL de la tokenlist copiée. Dans Uniswap : ⚙ > Token Lists > Add list > collez l’URL.");
    });
  });

  /*************** Uniswap embed fallback ***************/
  (function setupUni(){
    const frame = document.getElementById('uniFrame');
    const fb = document.getElementById('uniFallback');
    if(!frame || !fb) return;
    let ok=false;
    frame.addEventListener('load', ()=>{ ok=true; });
    setTimeout(()=>{ if(!ok){ fb.style.display='block'; frame.style.display='none'; } }, 2000);
  })();

  /*************** MetaMask connect (EIP-1193) ***************/
  const $ = (s)=>document.querySelector(s);
  const btnConnect = $("#btnConnect");
  const pill = $("#walletStatus");

  function getProvider(){
    if(window.ethereum?.providers?.length){
      return window.ethereum.providers.find(p=>p.isMetaMask) || window.ethereum.providers[0];
    }
    return window.ethereum || null;
  }
  async function ensureMainnet(eth){
    const cid = await eth.request({method:"eth_chainId"});
    if(cid==="0x1") return;
    try{
      await eth.request({method:"wallet_switchEthereumChain", params:[{chainId:"0x1"}]});
    }catch(e){
      if(e.code===4902){
        await eth.request({
          method:"wallet_addEthereumChain",
          params:[{chainId:"0x1", chainName:"Ethereum Mainnet",
                   nativeCurrency:{name:"Ether",symbol:"ETH",decimals:18},
                   rpcUrls:["https://cloudflare-eth.com"], blockExplorerUrls:["https://etherscan.io"]}]
        });
      } else { throw e; }
    }
  }
  function setBtn(t,dis=false){ if(btnConnect){ btnConnect.textContent=t; btnConnect.disabled=dis; } }
  function setPill(t){ if(!pill)return; if(!t){pill.style.display="none";return;} pill.textContent=t; pill.style.display="inline-block"; }

  let provider=null, signer=null, ethersjs=window.ethers, account=null;

  async function refreshBalances(){
    try{
      const net = await provider.getNetwork();
      const ethBal = await provider.getBalance(account);
      const ethF = Number(ethersjs.formatEther(ethBal)).toFixed(4);
      const erc = new ethersjs.Contract(ADDR.TOKEN,
        ["function decimals() view returns(uint8)","function symbol() view returns(string)","function balanceOf(address) view returns(uint256)"],
        provider);
      const [dec,sym,bal] = await Promise.all([
        erc.decimals().catch(()=>18),
        erc.symbol().catch(()=> "VNX"),
        erc.balanceOf(account)
      ]);
      const vnxF = Number(ethersjs.formatUnits(bal, dec)).toFixed(4);
      setPill(`${account.substring(0,6)}…${account.slice(-4)} • ${ethF} ETH • ${vnxF} ${sym}`);
    }catch(e){ console.warn(e); }
  }

  async function connect(){
    const eth = getProvider();
    if(!eth){ alert("MetaMask non détecté. Installe-le puis recharge la page."); window.open("https://metamask.io/download/","_blank"); return; }
    setBtn("Connecting…", true);
    try{
      await ensureMainnet(eth);
      const accs = await eth.request({method:"eth_requestAccounts"});
      if(!accs || !accs[0]){ setBtn("Connect Wallet"); return; }
      account = accs[0];
      provider = new ethersjs.BrowserProvider(eth);
      signer = await provider.getSigner();
      setBtn("Connected");
      await refreshBalances();
      // listeners
      eth.on?.("accountsChanged", async (a)=>{ if(a?.[0]){account=a[0]; await refreshBalances();} else { setBtn("Connect Wallet"); setPill(""); }});
      eth.on?.("chainChanged", async ()=>{ await refreshBalances(); });
    }catch(e){
      if(e.code===4001){ setBtn("Connect Wallet"); return; }
      console.error(e); alert("Connexion impossible : "+(e?.message||e));
      setBtn("Connect Wallet");
    } finally { btnConnect.disabled=false; }
  }
  btnConnect?.addEventListener("click", connect);
  (async ()=>{ // auto state
    const eth = getProvider(); if(!eth) return;
    const accs = await eth.request({method:"eth_accounts"}).catch(()=>[]);
    if(accs?.[0]){ account=accs[0]; provider=new ethersjs.BrowserProvider(eth); signer=await provider.getSigner(); setBtn("Connected"); refreshBalances(); }
  })();

  /*************** Add VNX to MetaMask ***************/
  document.getElementById('btnAddMM')?.addEventListener('click', async ()=>{
    try{
      const eth = getProvider(); if(!eth){alert('MetaMask non détecté');return}
      await eth.request({
        method: 'wallet_watchAsset',
        params: { type: 'ERC20', options: { address: ADDR.TOKEN, symbol:'VNX', decimals:18, image:'https://crz76.github.io/vnx-assets/vnx_logo_200.png' } }
      });
    }catch(e){ console.error(e); }
  });

  /*************** Swap natif (V2, fee-on-transfer OK) ***************/
  const ROUTER_ABI = [
    "function getAmountsOut(uint amountIn, address[] calldata path) external view returns (uint[] memory amounts)",
    "function swapExactETHForTokensSupportingFeeOnTransferTokens(uint amountOutMin, address[] calldata path, address to, uint deadline) external payable",
    "function swapExactTokensForETHSupportingFeeOnTransferTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) external"
  ];
  const ERC20_ABI = [
    "function decimals() view returns(uint8)",
    "function symbol() view returns(string)",
    "function balanceOf(address) view returns(uint256)",
    "function allowance(address,address) view returns(uint256)",
    "function approve(address,uint256) returns(bool)"
  ];
  const routerRead = new ethersjs.Contract(ADDR.ROUTER, ROUTER_ABI, new ethersjs.JsonRpcProvider("https://cloudflare-eth.com"));
  async function quoteBuy(){
    try{
      const amtEth = Number(document.getElementById("ethIn").value||"0");
      if(amtEth<=0) return;
      const out = await routerRead.getAmountsOut(ethersjs.parseEther(String(amtEth)), [ADDR.WETH, ADDR.TOKEN]);
      const vnx = Number(ethersjs.formatUnits(out[1], 18));
      document.getElementById("quoteBuy").textContent = `≈ ${vnx.toFixed(6)} VNX (hors slippage)`;
    }catch(e){ document.getElementById("quoteBuy").textContent = "—"; }
  }
  async function quoteSell(){
    try{
      const dec = 18;
      const amtVnx = Number(document.getElementById("vnxIn").value||"0");
      if(amtVnx<=0) return;
      const out = await routerRead.getAmountsOut(ethersjs.parseUnits(String(amtVnx), dec), [ADDR.TOKEN, ADDR.WETH]);
      const eth = Number(ethersjs.formatEther(out[1]));
      document.getElementById("quoteSell").textContent = `≈ ${eth.toFixed(6)} ETH (hors slippage)`;
    }catch(e){ document.getElementById("quoteSell").textContent = "—"; }
  }
  document.getElementById("btnQuoteBuy")?.addEventListener("click", quoteBuy);
  document.getElementById("btnQuoteSell")?.addEventListener("click", quoteSell);

  document.getElementById("btnSwapBuy")?.addEventListener("click", async ()=>{
    if(!signer) return alert("Connecte ton wallet d'abord.");
    const amtEth = Number(document.getElementById("ethIn").value||"0");
    const slip = Number(document.getElementById("slipBuy").value||"1");
    const deadlineMin = Number(document.getElementById("deadlineBuy").value||"15");
    if(amtEth<=0) return;
    const out = await routerRead.getAmountsOut(ethersjs.parseEther(String(amtEth)), [ADDR.WETH, ADDR.TOKEN]);
    const outMin = out[1] - (out[1] * BigInt(Math.floor(slip*1000)) / BigInt(100000)); // ~slippage
    const routerW = new ethersjs.Contract(ADDR.ROUTER, ROUTER_ABI, signer);
    const to = await signer.getAddress();
    const dl = Math.floor(Date.now()/1000) + deadlineMin*60;
    const tx = await routerW.swapExactETHForTokensSupportingFeeOnTransferTokens(outMin, [ADDR.WETH, ADDR.TOKEN], to, dl, { value: ethersjs.parseEther(String(amtEth)) });
    document.getElementById("quoteBuy").textContent = "Tx: "+tx.hash;
    await tx.wait();
    await refreshBalances();
  });

  // Approve router for sell
  document.getElementById("btnApproveRouter")?.addEventListener("click", async ()=>{
    if(!signer) return alert("Connecte ton wallet d'abord.");
    const erc = new ethersjs.Contract(ADDR.TOKEN, ERC20_ABI, signer);
    const tx = await erc.approve(ADDR.ROUTER, ethersjs.MaxUint256);
    document.getElementById("quoteSell").textContent = "Approve tx: "+tx.hash;
    await tx.wait();
  });

  document.getElementById("btnSwapSell")?.addEventListener("click", async ()=>{
    if(!signer) return alert("Connecte ton wallet d'abord.");
    const amtVnx = Number(document.getElementById("vnxIn").value||"0");
    const slip = Number(document.getElementById("slipSell").value||"1");
    const deadlineMin = Number(document.getElementById("deadlineSell").value||"15");
    if(amtVnx<=0) return;
    const amtIn = ethersjs.parseUnits(String(amtVnx), 18);
    const out = await routerRead.getAmountsOut(amtIn, [ADDR.TOKEN, ADDR.WETH]);
    const outMin = out[1] - (out[1] * BigInt(Math.floor(slip*1000)) / BigInt(100000));
    const routerW = new ethersjs.Contract(ADDR.ROUTER, ROUTER_ABI, signer);
    const to = await signer.getAddress();
    const dl = Math.floor(Date.now()/1000) + deadlineMin*60;
    const tx = await routerW.swapExactTokensForETHSupportingFeeOnTransferTokens(amtIn, outMin, [ADDR.TOKEN, ADDR.WETH], to, dl);
    document.getElementById("quoteSell").textContent = "Tx: "+tx.hash;
    await tx.wait();
    await refreshBalances();
  });

  /*************** Staking (générique) ***************/
  const STAKING_ABI = [
    "function stake(uint256) external",
    "function withdraw(uint256) external",
    "function getReward() external",
    "function claim() external",
    "function earned(address) view returns(uint256)",
    "function balanceOf(address) view returns(uint256)"
  ];
  async function updateStakeInfo(){
    try{
      if(!provider || !account) { document.getElementById("stakeInfo").textContent="—"; return; }
      const staking = new ethersjs.Contract(ADDR.STAKING, STAKING_ABI, provider);
      const [staked, earned] = await Promise.all([
        staking.balanceOf(account).catch(()=>0n),
        staking.earned(account).catch(()=>0n)
      ]);
      document.getElementById("stakeInfo").textContent =
        `Staked: ${Number(ethersjs.formatUnits(staked,18)).toFixed(4)} VNX • Earned: ${Number(ethersjs.formatUnits(earned,18)).toFixed(4)} VNX`;
    }catch(e){ document.getElementById("stakeInfo").textContent="—"; }
  }
  // approve staking
  document.getElementById("btnApproveStake")?.addEventListener("click", async ()=>{
    if(!signer) return alert("Connecte ton wallet d'abord.");
    const erc = new ethersjs.Contract(ADDR.TOKEN, ERC20_ABI, signer);
    const tx = await erc.approve(ADDR.STAKING, ethersjs.MaxUint256);
    await tx.wait(); await updateStakeInfo(); alert("Approve OK");
  });
  document.getElementById("btnStake")?.addEventListener("click", async ()=>{
    if(!signer) return alert("Connecte ton wallet d'abord.");
    const amt = Number(document.getElementById("stakeAmt").value||"0");
    if(amt<=0) return;
    const staking = new ethersjs.Contract(ADDR.STAKING, STAKING_ABI, signer);
    const tx = await staking.stake(ethersjs.parseUnits(String(amt),18));
    await tx.wait(); await updateStakeInfo();
  });
  document.getElementById("btnClaim")?.addEventListener("click", async ()=>{
    if(!signer) return alert("Connecte ton wallet d'abord.");
    const staking = new ethersjs.Contract(ADDR.STAKING, STAKING_ABI, signer);
    let tx; try{ tx = await staking.getReward(); }catch{ tx = await staking.claim(); }
    await tx.wait(); await updateStakeInfo();
  });
  document.getElementById("btnWithdraw")?.addEventListener("click", async ()=>{
    if(!signer) return alert("Connecte ton wallet d'abord.");
    const amt = Number(document.getElementById("stakeAmt").value||"0");
    if(amt<=0) return;
    const staking = new ethersjs.Contract(ADDR.STAKING, STAKING_ABI, signer);
    const tx = await staking.withdraw(ethersjs.parseUnits(String(amt),18));
    await tx.wait(); await updateStakeInfo();
  });
  // refresh on connect
  (function pollStake(){ setInterval(updateStakeInfo, 8000); })();

  /*************** Approvals viewer / revoke ***************/
  const allowanceOut = document.getElementById("allowanceOut");
  document.querySelectorAll('[data-spender]').forEach(b=>{
    b.addEventListener('click', ()=>{ document.getElementById('inpSpender').value = b.getAttribute('data-spender'); });
  });
  document.getElementById("btnCheckAllowance")?.addEventListener("click", async ()=>{
    if(!provider || !account) return alert("Connecte ton wallet d'abord.");
    const spender = document.getElementById("inpSpender").value.trim();
    if(!spender) return;
    const erc = new ethersjs.Contract(ADDR.TOKEN, ERC20_ABI, provider);
    const [dec,allow] = await Promise.all([
      erc.decimals().catch(()=>18),
      erc.allowance(account, spender)
    ]);
    allowanceOut.textContent = `Allowance: ${Number(ethersjs.formatUnits(allow,dec)).toFixed(6)} VNX`;
  });
  document.getElementById("btnRevoke")?.addEventListener("click", async ()=>{
    if(!signer) return alert("Connecte ton wallet d'abord.");
    const spender = document.getElementById("inpSpender").value.trim();
    if(!spender) return;
    const erc = new ethersjs.Contract(ADDR.TOKEN, ERC20_ABI, signer);
    const tx = await erc.approve(spender, 0);
    allowanceOut.textContent = "Revoke tx: "+tx.hash; await tx.wait(); document.getElementById("btnCheckAllowance").click();
  });
  document.getElementById("btnMax")?.addEventListener("click", async ()=>{
    if(!signer) return alert("Connecte ton wallet d'abord.");
    const spender = document.getElementById("inpSpender").value.trim();
    if(!spender) return;
    const erc = new ethersjs.Contract(ADDR.TOKEN, ERC20_ABI, signer);
    const tx = await erc.approve(spender, ethersjs.MaxUint256);
    allowanceOut.textContent = "Approve tx: "+tx.hash; await tx.wait(); document.getElementById("btnCheckAllowance").click();
  });
  </script>
</body>
</html>
